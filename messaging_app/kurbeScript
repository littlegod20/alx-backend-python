#!/bin/bash

# Script to start Kubernetes cluster locally using minikube
# and verify its status

set -e  # Exit on error

echo "========================================="
echo "Kubernetes Local Setup Script"
echo "========================================="
echo ""

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if kubectl is installed
echo "Checking for kubectl..."
if ! command_exists kubectl; then
    echo "ERROR: kubectl is not installed."
    echo "Please install kubectl first:"
    echo "  Windows: https://kubernetes.io/docs/tasks/tools/install-kubectl-windows/"
    echo "  Or use: choco install kubernetes-cli"
    exit 1
fi
echo "✓ kubectl is installed"
echo ""

# Check if minikube is installed
echo "Checking for minikube..."
if ! command_exists minikube; then
    echo "ERROR: minikube is not installed."
    echo "Please install minikube first:"
    echo "  Windows: https://minikube.sigs.k8s.io/docs/start/"
    echo "  Or use: choco install minikube"
    exit 1
fi
echo "✓ minikube is installed"
echo ""

# Check minikube status
echo "Checking minikube status..."
if minikube status >/dev/null 2>&1; then
    echo "Minikube cluster is already running"
    STATUS=$(minikube status --format='{{.Host}}')
    if [[ "$STATUS" == *"Running"* ]]; then
        echo "✓ Cluster is already running"
    else
        echo "Starting minikube cluster..."
        minikube start
    fi
else
    echo "Starting minikube cluster..."
    minikube start
fi
echo ""

# Wait a moment for cluster to be fully ready
echo "Waiting for cluster to be ready..."
sleep 5
echo ""

# Verify cluster is running using kubectl cluster-info
echo "========================================="
echo "Verifying cluster status..."
echo "========================================="
echo ""
echo "Running: kubectl cluster-info"
kubectl cluster-info
echo ""

# Check if cluster-info was successful
if [ $? -eq 0 ]; then
    echo "✓ Cluster is running and accessible"
else
    echo "✗ Failed to get cluster info"
    exit 1
fi
echo ""

# Retrieve available pods
echo "========================================="
echo "Retrieving available pods..."
echo "========================================="
echo ""
echo "Running: kubectl get pods --all-namespaces"
kubectl get pods --all-namespaces
echo ""

# Also show pods in default namespace
echo "Running: kubectl get pods"
kubectl get pods
echo ""

echo "========================================="
echo "Setup complete!"
echo "========================================="
echo ""
echo "Cluster information:"
minikube status
echo ""
echo "To access the cluster dashboard, run:"
echo "  minikube dashboard"
echo ""
echo "To stop the cluster, run:"
echo "  minikube stop"
echo ""


