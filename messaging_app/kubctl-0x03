#!/bin/bash

# Script for rolling update deployment
# kubctl-0x03: Applies rolling update and monitors for downtime

set -e  # Exit on error

echo "========================================="
echo "Rolling Update Deployment Script"
echo "========================================="
echo ""

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if kubectl is installed
echo "Checking for kubectl..."
if ! command_exists kubectl; then
    echo "ERROR: kubectl is not installed."
    exit 1
fi
echo "✓ kubectl is installed"
echo ""

# Check if curl is installed
echo "Checking for curl..."
if ! command_exists curl; then
    echo "ERROR: curl is not installed."
    exit 1
fi
echo "✓ curl is installed"
echo ""

# Configuration
DEPLOYMENT_NAME="django-messaging-app-blue"
SERVICE_NAME="django-messaging-app-service"
DEPLOYMENT_FILE="blue_deployment.yaml"
TEST_URL="http://localhost:8000"
TEST_INTERVAL=2  # seconds between requests
TEST_DURATION=120  # total duration for continuous testing (seconds)

# Step 1: Get current deployment status
echo "========================================="
echo "Step 1: Current Deployment Status"
echo "========================================="
echo ""

echo "Current deployment:"
kubectl get deployment $DEPLOYMENT_NAME || {
    echo "⚠ Warning: Deployment not found. Will create it."
}
echo ""

echo "Current pods:"
kubectl get pods -l app=django-messaging-app,version=blue
echo ""

# Get current image version
CURRENT_IMAGE=$(kubectl get deployment $DEPLOYMENT_NAME -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "none")
echo "Current image: $CURRENT_IMAGE"
echo ""

# Step 2: Set up port-forwarding for testing
echo "========================================="
echo "Step 2: Setting up Port-Forwarding"
echo "========================================="
echo ""

echo "Setting up port-forward to service..."
kubectl port-forward service/$SERVICE_NAME 8000:8000 > /dev/null 2>&1 &
PORT_FORWARD_PID=$!

# Wait for port-forward to establish
sleep 3

# Check if port-forward is working
if ! kill -0 $PORT_FORWARD_PID 2>/dev/null; then
    echo "⚠ Warning: Port-forward may have failed. Trying alternative method..."
    # Try direct pod port-forward as fallback
    FIRST_POD=$(kubectl get pods -l app=django-messaging-app,version=blue -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
    if [ -n "$FIRST_POD" ]; then
        kubectl port-forward pod/$FIRST_POD 8000:8000 > /dev/null 2>&1 &
        PORT_FORWARD_PID=$!
        sleep 3
    else
        echo "⚠ Could not establish port-forward. Testing will be limited."
        PORT_FORWARD_PID=""
    fi
fi

if [ -n "$PORT_FORWARD_PID" ]; then
    echo "✓ Port-forwarding established (PID: $PORT_FORWARD_PID)"
    echo "  Testing URL: $TEST_URL"
else
    echo "⚠ Port-forwarding not available. Will skip continuous testing."
fi
echo ""

# Step 3: Pre-update health check
echo "========================================="
echo "Step 3: Pre-Update Health Check"
echo "========================================="
echo ""

if [ -n "$PORT_FORWARD_PID" ]; then
    echo "Testing app availability before update..."
    PRE_UPDATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 $TEST_URL/ || echo "000")
    if [ "$PRE_UPDATE_STATUS" = "200" ] || [ "$PRE_UPDATE_STATUS" = "404" ] || [ "$PRE_UPDATE_STATUS" = "301" ] || [ "$PRE_UPDATE_STATUS" = "302" ]; then
        echo "✓ App is responding (HTTP $PRE_UPDATE_STATUS)"
    else
        echo "⚠ App may not be responding (HTTP $PRE_UPDATE_STATUS)"
    fi
else
    echo "⚠ Skipping pre-update health check (no port-forward)"
fi
echo ""

# Step 4: Start continuous testing in background
echo "========================================="
echo "Step 4: Starting Continuous Testing"
echo "========================================="
echo ""

if [ -n "$PORT_FORWARD_PID" ]; then
    echo "Starting continuous curl requests to monitor for downtime..."
    echo "  URL: $TEST_URL"
    echo "  Interval: ${TEST_INTERVAL}s"
    echo "  Duration: ${TEST_DURATION}s"
    echo ""
    
    # Create a temporary file to track test results
    TEST_LOG=$(mktemp)
    FAILED_REQUESTS=0
    TOTAL_REQUESTS=0
    
    # Function to run continuous tests
    run_continuous_tests() {
        local end_time=$(($(date +%s) + TEST_DURATION))
        local request_num=0
        
        while [ $(date +%s) -lt $end_time ]; do
            request_num=$((request_num + 1))
            timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            
            # Make request with timeout
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 "$TEST_URL/" 2>/dev/null || echo "000")
            
            if [ "$http_code" = "200" ] || [ "$http_code" = "404" ] || [ "$http_code" = "301" ] || [ "$http_code" = "302" ]; then
                echo "[$timestamp] Request #$request_num: SUCCESS (HTTP $http_code)" >> "$TEST_LOG"
            else
                echo "[$timestamp] Request #$request_num: FAILED (HTTP $http_code)" >> "$TEST_LOG"
                FAILED_REQUESTS=$((FAILED_REQUESTS + 1))
            fi
            TOTAL_REQUESTS=$((TOTAL_REQUESTS + 1))
            
            sleep $TEST_INTERVAL
        done
    }
    
    # Run tests in background
    run_continuous_tests &
    TEST_PID=$!
    echo "✓ Continuous testing started (PID: $TEST_PID)"
    echo ""
else
    echo "⚠ Skipping continuous testing (no port-forward available)"
    TEST_PID=""
fi

# Step 5: Apply the updated deployment
echo "========================================="
echo "Step 5: Applying Rolling Update"
echo "========================================="
echo ""

echo "Applying updated deployment from $DEPLOYMENT_FILE..."
kubectl apply -f $DEPLOYMENT_FILE

if [ $? -eq 0 ]; then
    echo "✓ Deployment applied successfully"
else
    echo "✗ Failed to apply deployment"
    # Cleanup
    [ -n "$PORT_FORWARD_PID" ] && kill $PORT_FORWARD_PID 2>/dev/null || true
    [ -n "$TEST_PID" ] && kill $TEST_PID 2>/dev/null || true
    exit 1
fi
echo ""

# Get new image version
NEW_IMAGE=$(kubectl get deployment $DEPLOYMENT_NAME -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "unknown")
echo "New image: $NEW_IMAGE"
echo ""

# Step 6: Monitor rollout status
echo "========================================="
echo "Step 6: Monitoring Rollout Status"
echo "========================================="
echo ""

echo "Monitoring rollout progress..."
echo "This may take a few minutes..."
echo ""

# Monitor rollout with timeout
kubectl rollout status deployment/$DEPLOYMENT_NAME --timeout=300s

ROLLOUT_EXIT_CODE=$?

if [ $ROLLOUT_EXIT_CODE -eq 0 ]; then
    echo "✓ Rollout completed successfully"
else
    echo "⚠ Rollout may not have completed successfully (exit code: $ROLLOUT_EXIT_CODE)"
fi
echo ""

# Step 7: Wait for continuous testing to complete
if [ -n "$TEST_PID" ]; then
    echo "Waiting for continuous testing to complete..."
    wait $TEST_PID 2>/dev/null || true
    echo "✓ Continuous testing completed"
    echo ""
    
    # Show test results
    echo "========================================="
    echo "Step 7: Continuous Test Results"
    echo "========================================="
    echo ""
    
    if [ -f "$TEST_LOG" ]; then
        echo "Test Summary:"
        echo "  Total requests: $TOTAL_REQUESTS"
        echo "  Failed requests: $FAILED_REQUESTS"
        
        if [ $FAILED_REQUESTS -eq 0 ]; then
            echo "  ✓ No downtime detected during rolling update!"
        else
            SUCCESS_RATE=$(echo "scale=2; ($TOTAL_REQUESTS - $FAILED_REQUESTS) * 100 / $TOTAL_REQUESTS" | bc 2>/dev/null || echo "N/A")
            echo "  ⚠ Some requests failed (Success rate: ${SUCCESS_RATE}%)"
            echo ""
            echo "Failed requests:"
            grep "FAILED" "$TEST_LOG" | head -10
        fi
        echo ""
        
        # Show sample of recent requests
        echo "Recent test results (last 10 requests):"
        tail -10 "$TEST_LOG"
        echo ""
        
        # Cleanup test log
        rm -f "$TEST_LOG"
    fi
fi

# Step 8: Verify rolling update is complete
echo "========================================="
echo "Step 8: Verifying Rolling Update"
echo "========================================="
echo ""

echo "Deployment status:"
kubectl get deployment $DEPLOYMENT_NAME
echo ""

echo "Current pods:"
kubectl get pods -l app=django-messaging-app,version=blue
echo ""

# Check pod status
POD_COUNT=$(kubectl get pods -l app=django-messaging-app,version=blue --no-headers 2>/dev/null | wc -l | tr -d ' ')
RUNNING_COUNT=$(kubectl get pods -l app=django-messaging-app,version=blue --no-headers 2>/dev/null | grep -c "Running" || echo "0")
READY_COUNT=$(kubectl get pods -l app=django-messaging-app,version=blue --no-headers 2>/dev/null | grep -c "Running.*1/1" || echo "0")

echo "Pod Summary:"
echo "  Total pods: $POD_COUNT"
echo "  Running pods: $RUNNING_COUNT"
echo "  Ready pods: $READY_COUNT"
echo ""

# Verify image version
echo "Verifying image version in pods:"
PODS=$(kubectl get pods -l app=django-messaging-app,version=blue -o jsonpath='{.items[*].metadata.name}')
ALL_CORRECT=true
for POD in $PODS; do
    POD_IMAGE=$(kubectl get pod $POD -o jsonpath='{.spec.containers[0].image}' 2>/dev/null || echo "unknown")
    if [[ "$POD_IMAGE" == *"2.0"* ]]; then
        echo "  ✓ $POD: $POD_IMAGE"
    else
        echo "  ⚠ $POD: $POD_IMAGE (expected version 2.0)"
        ALL_CORRECT=false
    fi
done
echo ""

# Step 9: Post-update health check
echo "========================================="
echo "Step 9: Post-Update Health Check"
echo "========================================="
echo ""

if [ -n "$PORT_FORWARD_PID" ]; then
    echo "Testing app availability after update..."
    sleep 2  # Give it a moment to stabilize
    
    POST_UPDATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 $TEST_URL/ || echo "000")
    if [ "$POST_UPDATE_STATUS" = "200" ] || [ "$POST_UPDATE_STATUS" = "404" ] || [ "$POST_UPDATE_STATUS" = "301" ] || [ "$POST_UPDATE_STATUS" = "302" ]; then
        echo "✓ App is responding after update (HTTP $POST_UPDATE_STATUS)"
    else
        echo "⚠ App may not be responding (HTTP $POST_UPDATE_STATUS)"
    fi
else
    echo "⚠ Skipping post-update health check (no port-forward)"
fi
echo ""

# Cleanup port-forward
if [ -n "$PORT_FORWARD_PID" ]; then
    echo "Cleaning up port-forward..."
    kill $PORT_FORWARD_PID 2>/dev/null || true
    sleep 1
    echo "✓ Port-forward closed"
    echo ""
fi

# Final summary
echo "========================================="
echo "Rolling Update Summary"
echo "========================================="
echo ""
echo "Deployment: $DEPLOYMENT_NAME"
echo "Previous image: $CURRENT_IMAGE"
echo "New image: $NEW_IMAGE"
echo "Rollout status: $([ $ROLLOUT_EXIT_CODE -eq 0 ] && echo "Success" || echo "Completed with warnings")"
echo "Pods running: $RUNNING_COUNT"
echo "Pods ready: $READY_COUNT"
echo "Image verification: $([ "$ALL_CORRECT" = true ] && echo "All pods using version 2.0" || echo "Some pods may not be updated")"
if [ -n "$TEST_PID" ]; then
    echo "Downtime detected: $([ $FAILED_REQUESTS -eq 0 ] && echo "No" || echo "Yes ($FAILED_REQUESTS failed requests)")"
fi
echo ""

if [ $ROLLOUT_EXIT_CODE -eq 0 ] && [ "$ALL_CORRECT" = true ] && [ $READY_COUNT -gt 0 ]; then
    echo "✓ Rolling update completed successfully!"
    echo "✓ No downtime detected during update"
    echo "✓ All pods are running the new version (2.0)"
else
    echo "⚠ Rolling update completed with some issues"
    echo "  Please review the output above"
fi
echo ""

echo "Useful commands:"
echo "  View deployment: kubectl get deployment $DEPLOYMENT_NAME"
echo "  View pods: kubectl get pods -l app=django-messaging-app,version=blue"
echo "  View rollout history: kubectl rollout history deployment/$DEPLOYMENT_NAME"
echo "  Rollback if needed: kubectl rollout undo deployment/$DEPLOYMENT_NAME"
echo ""
echo "========================================="
echo "Script completed!"
echo "========================================="
